{"version":3,"file":"util.js","names":["_fsReaddirRecursive","data","require","babel","_path","_fs","watcher","asyncGeneratorStep","gen","resolve","reject","_next","_throw","key","arg","info","value","error","done","Promise","then","_asyncToGenerator","fn","self","args","arguments","apply","err","undefined","chmod","src","dest","chmodSync","statSync","mode","console","warn","concat","readdir","dirname","includeDotfiles","filter","filename","index","currentDirectory","stat","join","isDirectory","readdirForCompilable","altExts","isCompilableExtension","exts","DEFAULT_EXTENSIONS","ext","extname","includes","addSourceMappingUrl","code","loc","basename","hasDataSourcemap","pos","lastIndexOf","length","CALLER","name","transformRepl","opts","Object","assign","caller","transform","result","compile","_x","_x2","_compile","_regeneratorRuntime","mark","_callee","wrap","_callee$","_context","prev","next","transformFile","sent","externalDependencies","abrupt","updateExternalDependencies","stop","deleteDir","path","existsSync","readdirSync","forEach","file","curPath","lstatSync","unlinkSync","rmdirSync","process","on","exitCode","withExtension","newBasename","debounce","time","timer","debounced","clearTimeout","setTimeout","flush"],"sources":["../../src/babel/util.ts"],"sourcesContent":["import readdirRecursive from \"fs-readdir-recursive\";\nimport * as babel from \"@babel/core\";\nimport path from \"path\";\nimport fs from \"fs\";\n\nimport * as watcher from \"./watcher.ts\";\n\nimport type { FileResult, InputOptions } from \"@babel/core\";\n\nexport function chmod(src: string, dest: string): void {\n  try {\n    fs.chmodSync(dest, fs.statSync(src).mode);\n  } catch (err) {\n    console.warn(`Cannot change permissions of ${dest}`);\n  }\n}\n\ntype ReaddirFilter = (filename: string) => boolean;\n\nexport function readdir(\n  dirname: string,\n  includeDotfiles: boolean,\n  filter?: ReaddirFilter,\n): Array<string> {\n  return readdirRecursive(dirname, (filename, index, currentDirectory) => {\n    const stat = fs.statSync(path.join(currentDirectory, filename));\n\n    if (stat.isDirectory()) return true;\n\n    return (\n      (includeDotfiles || filename[0] !== \".\") && (!filter || filter(filename))\n    );\n  });\n}\n\nexport function readdirForCompilable(\n  dirname: string,\n  includeDotfiles: boolean,\n  altExts?: Array<string>,\n): Array<string> {\n  return readdir(dirname, includeDotfiles, function (filename) {\n    return isCompilableExtension(filename, altExts);\n  });\n}\n\n/**\n * Test if a filename ends with a compilable extension.\n */\nexport function isCompilableExtension(\n  filename: string,\n  altExts?: readonly string[],\n): boolean {\n  const exts = altExts || babel.DEFAULT_EXTENSIONS;\n  const ext = path.extname(filename);\n  return exts.includes(ext);\n}\n\nexport function addSourceMappingUrl(code: string, loc: string): string {\n  return code + \"\\n//# sourceMappingURL=\" + path.basename(loc);\n}\n\nexport function hasDataSourcemap(code: string): boolean {\n  const pos = code.lastIndexOf(\"\\n\", code.length - 2);\n  return pos != -1 && code.lastIndexOf(\"//# sourceMappingURL\") < pos;\n}\n\nconst CALLER = {\n  name: \"@babel/cli\",\n};\n\nexport function transformRepl(filename: string, code: string, opts: any) {\n  opts = {\n    ...opts,\n    caller: CALLER,\n    filename,\n  };\n\n  return new Promise<FileResult>((resolve, reject) => {\n    babel.transform(code, opts, (err, result) => {\n      if (err) reject(err);\n      else resolve(result);\n    });\n  });\n}\n\nexport async function compile(filename: string, opts: InputOptions) {\n  opts = {\n    ...opts,\n    caller: CALLER,\n  };\n\n  const result = process.env.BABEL_8_BREAKING\n    ? await babel.transformFileAsync(filename, opts)\n    : await new Promise<FileResult>((resolve, reject) => {\n        babel.transformFile(filename, opts, (err, result) => {\n          if (err) reject(err);\n          else resolve(result);\n        });\n      });\n\n  if (result) {\n    if (!process.env.BABEL_8_BREAKING) {\n      if (!result.externalDependencies) return result;\n    }\n    watcher.updateExternalDependencies(filename, result.externalDependencies);\n  }\n\n  return result;\n}\n\nexport function deleteDir(path: string): void {\n  if (fs.existsSync(path)) {\n    fs.readdirSync(path).forEach(function (file) {\n      const curPath = path + \"/\" + file;\n      if (fs.lstatSync(curPath).isDirectory()) {\n        // recurse\n        deleteDir(curPath);\n      } else {\n        // delete file\n        fs.unlinkSync(curPath);\n      }\n    });\n    fs.rmdirSync(path);\n  }\n}\n\nprocess.on(\"uncaughtException\", function (err) {\n  console.error(err);\n  process.exitCode = 1;\n});\n\nexport function withExtension(filename: string, ext: string = \".js\") {\n  const newBasename = path.basename(filename, path.extname(filename)) + ext;\n  return path.join(path.dirname(filename), newBasename);\n}\n\nexport function debounce(fn: () => void, time: number) {\n  let timer: NodeJS.Timeout;\n  function debounced() {\n    clearTimeout(timer);\n    timer = setTimeout(fn, time);\n  }\n  debounced.flush = () => {\n    clearTimeout(timer);\n    fn();\n  };\n  return debounced;\n}\n"],"mappings":"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","ignoreList":[]}