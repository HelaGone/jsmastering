{"version":3,"file":"block-hoist-plugin.js","names":["_traverse","data","require","_plugin","LOADED_PLUGIN","blockHoistPlugin","name","visitor","Block","exit","_ref","node","body","max","Math","pow","hasChange","i","length","n","p","priority","stableSort","slice","loadBlockHoistPlugin","Object","assign","explode","bodyNode","_blockHoist","buckets","create","bucket","push","keys","map","k","sort","a","b","index","_iterator","_createForOfIteratorHelper","_step","s","done","key","value","_iterator2","_step2","err","e","f"],"sources":["../../src/transformation/block-hoist-plugin.ts"],"sourcesContent":["import traverse from \"@babel/traverse\";\nimport type { Statement } from \"@babel/types\";\nimport type { PluginObject } from \"../config/index.ts\";\nimport Plugin from \"../config/plugin.ts\";\n\nlet LOADED_PLUGIN: Plugin | void;\n\nconst blockHoistPlugin: PluginObject = {\n  /**\n   * [Please add a description.]\n   *\n   * Priority:\n   *\n   *  - 0 We want this to be at the **very** bottom\n   *  - 1 Default node position\n   *  - 2 Priority over normal nodes\n   *  - 3 We want this to be at the **very** top\n   *  - 4 Reserved for the helpers used to implement module imports.\n   */\n\n  name: \"internal.blockHoist\",\n\n  visitor: {\n    Block: {\n      exit({ node }) {\n        const { body } = node;\n\n        // Largest SMI\n        let max = 2 ** 30 - 1;\n        let hasChange = false;\n        for (let i = 0; i < body.length; i++) {\n          const n = body[i];\n          const p = priority(n);\n          if (p > max) {\n            hasChange = true;\n            break;\n          }\n          max = p;\n        }\n        if (!hasChange) return;\n\n        // My kingdom for a stable sort!\n        node.body = stableSort(body.slice());\n      },\n    },\n  },\n};\n\nexport default function loadBlockHoistPlugin(): Plugin {\n  if (!LOADED_PLUGIN) {\n    // cache the loaded blockHoist plugin plugin\n    LOADED_PLUGIN = new Plugin(\n      {\n        ...blockHoistPlugin,\n        visitor: traverse.explode(blockHoistPlugin.visitor),\n      },\n      {},\n    );\n  }\n\n  return LOADED_PLUGIN;\n}\n\nfunction priority(bodyNode: Statement & { _blockHoist?: number | true }) {\n  const priority = bodyNode?._blockHoist;\n  if (priority == null) return 1;\n  if (priority === true) return 2;\n  return priority;\n}\n\nfunction stableSort(body: Statement[]) {\n  // By default, we use priorities of 0-4.\n  const buckets = Object.create(null);\n\n  // By collecting into buckets, we can guarantee a stable sort.\n  for (let i = 0; i < body.length; i++) {\n    const n = body[i];\n    const p = priority(n);\n\n    // In case some plugin is setting an unexpected priority.\n    const bucket = buckets[p] || (buckets[p] = []);\n    bucket.push(n);\n  }\n\n  // Sort our keys in descending order. Keys are unique, so we don't have to\n  // worry about stability.\n  const keys = Object.keys(buckets)\n    .map(k => +k)\n    .sort((a, b) => b - a);\n\n  let index = 0;\n  for (const key of keys) {\n    const bucket = buckets[key];\n    for (const n of bucket) {\n      body[index++] = n;\n    }\n  }\n  return body;\n}\n"],"mappings":";;;;;;;;;AAAA,SAAAA,UAAA;EAAA,IAAAC,IAAA,GAAAC,OAAA;EAAAF,SAAA,YAAAA,UAAA;IAAA,OAAAC,IAAA;EAAA;EAAA,OAAAA,IAAA;AAAA;AAGA,IAAAE,OAAA,GAAAD,OAAA;AAEA,IAAIE,aAA4B;AAEhC,IAAMC,gBAA8B,GAAG;EAarCC,IAAI,EAAE,qBAAqB;EAE3BC,OAAO,EAAE;IACPC,KAAK,EAAE;MACLC,IAAI,WAAAA,KAAAC,IAAA,EAAW;QAAA,IAARC,IAAA,GAAAD,IAAA,CAAAC,IAAA;QACL,IAAQC,IAAA,GAASD,IAAI,CAAbC,IAAA;QAGR,IAAIC,GAAG,GAAGC,IAAA,CAAAC,GAAA,EAAC,EAAI,EAAE,IAAG,CAAC;QACrB,IAAIC,SAAS,GAAG,KAAK;QACrB,KAAK,IAAIC,CAAC,GAAG,CAAC,EAAEA,CAAC,GAAGL,IAAI,CAACM,MAAM,EAAED,CAAC,EAAE,EAAE;UACpC,IAAME,CAAC,GAAGP,IAAI,CAACK,CAAC,CAAC;UACjB,IAAMG,CAAC,GAAGC,QAAQ,CAACF,CAAC,CAAC;UACrB,IAAIC,CAAC,GAAGP,GAAG,EAAE;YACXG,SAAS,GAAG,IAAI;YAChB;UACF;UACAH,GAAG,GAAGO,CAAC;QACT;QACA,IAAI,CAACJ,SAAS,EAAE;QAGhBL,IAAI,CAACC,IAAI,GAAGU,UAAU,CAACV,IAAI,CAACW,KAAK,CAAC,CAAC,CAAC;MACtC;IACF;EACF;AACF,CAAC;AAEc,SAASC,oBAAoBA,CAAA,EAAW;EACrD,IAAI,CAACpB,aAAa,EAAE;IAElBA,aAAa,GAAG,IAAID,OAAA,WAAM,CAAAsB,MAAA,CAAAC,MAAA,KAEnBrB,gBAAgB;MACnBE,OAAO,EAAEP,SAAA,aAAQ,CAAC2B,OAAO,CAACtB,gBAAgB,CAACE,OAAO;IAAC,IAErD,CAAC,CACH,CAAC;EACH;EAEA,OAAOH,aAAa;AACtB;AAEA,SAASiB,QAAQA,CAACO,QAAqD,EAAE;EACvE,IAAMP,QAAQ,GAAGO,QAAQ,oBAARA,QAAQ,CAAEC,WAAW;EACtC,IAAIR,QAAQ,IAAI,IAAI,EAAE,OAAO,CAAC;EAC9B,IAAIA,QAAQ,KAAK,IAAI,EAAE,OAAO,CAAC;EAC/B,OAAOA,QAAQ;AACjB;AAEA,SAASC,UAAUA,CAACV,IAAiB,EAAE;EAErC,IAAMkB,OAAO,GAAGL,MAAM,CAACM,MAAM,CAAC,IAAI,CAAC;EAGnC,KAAK,IAAId,CAAC,GAAG,CAAC,EAAEA,CAAC,GAAGL,IAAI,CAACM,MAAM,EAAED,CAAC,EAAE,EAAE;IACpC,IAAME,CAAC,GAAGP,IAAI,CAACK,CAAC,CAAC;IACjB,IAAMG,CAAC,GAAGC,QAAQ,CAACF,CAAC,CAAC;IAGrB,IAAMa,MAAM,GAAGF,OAAO,CAACV,CAAC,CAAC,KAAKU,OAAO,CAACV,CAAC,CAAC,GAAG,EAAE,CAAC;IAC9CY,MAAM,CAACC,IAAI,CAACd,CAAC,CAAC;EAChB;EAIA,IAAMe,IAAI,GAAGT,MAAM,CAACS,IAAI,CAACJ,OAAO,CAAC,CAC9BK,GAAG,CAAC,UAAAC,CAAC;IAAA,OAAI,CAACA,CAAC;EAAA,EAAC,CACZC,IAAI,CAAC,UAACC,CAAC,EAAEC,CAAC;IAAA,OAAKA,CAAC,GAAGD,CAAC;EAAA,EAAC;EAExB,IAAIE,KAAK,GAAG,CAAC;EAAA,IAAAC,SAAA,GAAAC,0BAAA,CACKR,IAAI;IAAAS,KAAA;EAAA;IAAtB,KAAAF,SAAA,CAAAG,CAAA,MAAAD,KAAA,GAAAF,SAAA,CAAAtB,CAAA,IAAA0B,IAAA,GAAwB;MAAA,IAAbC,GAAG,GAAAH,KAAA,CAAAI,KAAA;MACZ,IAAMf,OAAM,GAAGF,OAAO,CAACgB,GAAG,CAAC;MAAA,IAAAE,UAAA,GAAAN,0BAAA,CACXV,OAAM;QAAAiB,MAAA;MAAA;QAAtB,KAAAD,UAAA,CAAAJ,CAAA,MAAAK,MAAA,GAAAD,UAAA,CAAA7B,CAAA,IAAA0B,IAAA,GAAwB;UAAA,IAAb1B,EAAC,GAAA8B,MAAA,CAAAF,KAAA;UACVnC,IAAI,CAAC4B,KAAK,EAAE,CAAC,GAAGrB,EAAC;QACnB;MAAA,SAAA+B,GAAA;QAAAF,UAAA,CAAAG,CAAA,CAAAD,GAAA;MAAA;QAAAF,UAAA,CAAAI,CAAA;MAAA;IACF;EAAA,SAAAF,GAAA;IAAAT,SAAA,CAAAU,CAAA,CAAAD,GAAA;EAAA;IAAAT,SAAA,CAAAW,CAAA;EAAA;EACA,OAAOxC,IAAI;AACb;AAAC","ignoreList":[]}