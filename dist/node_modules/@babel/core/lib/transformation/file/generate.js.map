{"version":3,"file":"generate.js","names":["_convertSourceMap","data","require","_generator","_mergeMap","generateCode","pluginPasses","file","opts","ast","code","inputMap","generatorOpts","inputSourceMap","toObject","results","_iterator","_createForOfIteratorHelper","_step","s","n","done","plugins","value","_iterator2","_step2","plugin","generatorOverride","result","undefined","push","err","e","f","length","then","Error","_result","outputCode","_result$decodedMap","decodedMap","outputMap","map","__mergedMap","Object","assign","sourceFileName","sourceMaps","fromObject","toComment"],"sources":["../../../src/transformation/file/generate.ts"],"sourcesContent":["import type { PluginPasses } from \"../../config/index.ts\";\nimport convertSourceMap from \"convert-source-map\";\nimport type { GeneratorResult } from \"@babel/generator\";\nimport generate from \"@babel/generator\";\n\nimport type File from \"./file.ts\";\nimport mergeSourceMap from \"./merge-map.ts\";\n\nexport default function generateCode(\n  pluginPasses: PluginPasses,\n  file: File,\n): {\n  outputCode: string;\n  outputMap: GeneratorResult[\"map\"] | null;\n} {\n  const { opts, ast, code, inputMap } = file;\n  const { generatorOpts } = opts;\n\n  generatorOpts.inputSourceMap = inputMap?.toObject();\n\n  const results = [];\n  for (const plugins of pluginPasses) {\n    for (const plugin of plugins) {\n      const { generatorOverride } = plugin;\n      if (generatorOverride) {\n        const result = generatorOverride(ast, generatorOpts, code, generate);\n\n        if (result !== undefined) results.push(result);\n      }\n    }\n  }\n\n  let result;\n  if (results.length === 0) {\n    result = generate(ast, generatorOpts, code);\n  } else if (results.length === 1) {\n    result = results[0];\n\n    if (typeof result.then === \"function\") {\n      throw new Error(\n        `You appear to be using an async codegen plugin, ` +\n          `which your current version of Babel does not support. ` +\n          `If you're using a published plugin, ` +\n          `you may need to upgrade your @babel/core version.`,\n      );\n    }\n  } else {\n    throw new Error(\"More than one plugin attempted to override codegen.\");\n  }\n\n  // Decoded maps are faster to merge, so we attempt to get use the decodedMap\n  // first. But to preserve backwards compat with older Generator, we'll fall\n  // back to the encoded map.\n  let { code: outputCode, decodedMap: outputMap = result.map } = result;\n\n  // For backwards compat.\n  if (result.__mergedMap) {\n    /**\n     * @see mergeSourceMap\n     */\n    outputMap = { ...result.map };\n  } else {\n    if (outputMap) {\n      if (inputMap) {\n        // mergeSourceMap returns an encoded map\n        outputMap = mergeSourceMap(\n          inputMap.toObject(),\n          outputMap,\n          generatorOpts.sourceFileName,\n        );\n      } else {\n        // We cannot output a decoded map, so retrieve the encoded form. Because\n        // the decoded form is free, it's fine to prioritize decoded first.\n        outputMap = result.map;\n      }\n    }\n  }\n\n  if (opts.sourceMaps === \"inline\" || opts.sourceMaps === \"both\") {\n    outputCode += \"\\n\" + convertSourceMap.fromObject(outputMap).toComment();\n  }\n\n  if (opts.sourceMaps === \"inline\") {\n    outputMap = null;\n  }\n\n  return { outputCode, outputMap };\n}\n"],"mappings":"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","ignoreList":[]}