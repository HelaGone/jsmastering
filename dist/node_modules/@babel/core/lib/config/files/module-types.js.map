{"version":3,"file":"module-types.js","names":["loadCodeDefault","_async","require","_path","data","_url","_semver","_debug","_rewriteStackTrace","_configError","_transformFile","asyncGeneratorStep","gen","resolve","reject","_next","_throw","key","arg","info","value","error","done","Promise","then","_asyncToGenerator","fn","self","args","arguments","apply","err","undefined","debug","import_","_unused","supportsESM","exports","satisfies","process","versions","node","filepath","asyncError","_args","_regeneratorRuntime","wrap","loadCodeDefault$","_context","prev","next","t0","extname","abrupt","loadCjsDefault","loadCtsDefault","t1","code","delegateYield","isAsync","t2","waitFor","loadMjsDefault","t3","stop","_marked","ext","hasTsSupport","extensions","handler","opts","babelrc","configFile","sourceType","sourceMaps","sourceFileName","basename","presets","getTSPreset","Object","assign","onlyRemoveTypeImports","optimizeConstEnums","allowDeclareFields","m","filename","endsWith","_compile","transformFileSync","packageJson","lt","version","console","LOADING_CJS_FILES","Set","has","module","add","endHiddenCallStack","_module","__esModule","_loadMjsDefault","mark","_callee","url","_callee$","_context2","pathToFileURL","toString","sent","_x","message","pnp"],"sources":["../../../src/config/files/module-types.ts"],"sourcesContent":["import { isAsync, waitFor } from \"../../gensync-utils/async.ts\";\nimport type { Handler } from \"gensync\";\nimport path from \"path\";\nimport { pathToFileURL } from \"url\";\nimport { createRequire } from \"module\";\nimport semver from \"semver\";\nimport buildDebug from \"debug\";\n\nimport { endHiddenCallStack } from \"../../errors/rewrite-stack-trace.ts\";\nimport ConfigError from \"../../errors/config-error.ts\";\n\nimport type { InputOptions } from \"../index.ts\";\nimport { transformFileSync } from \"../../transform-file.ts\";\n\nconst debug = buildDebug(\"babel:config:loading:files:module-types\");\n\nconst require = createRequire(import.meta.url);\n\nif (!process.env.BABEL_8_BREAKING) {\n  try {\n    // Old Node.js versions don't support import() syntax.\n    // eslint-disable-next-line no-var\n    var import_:\n      | ((specifier: string | URL) => any)\n      | undefined = require(\"./import.cjs\");\n  } catch {}\n}\n\nexport const supportsESM = semver.satisfies(\n  process.versions.node,\n  // older versions, starting from 10, support the dynamic\n  // import syntax but always return a rejected promise.\n  \"^12.17 || >=13.2\",\n);\n\nexport default function* loadCodeDefault(\n  filepath: string,\n  asyncError: string,\n): Handler<unknown> {\n  switch (path.extname(filepath)) {\n    case \".cjs\":\n      if (process.env.BABEL_8_BREAKING) {\n        return loadCjsDefault(filepath);\n      } else {\n        return loadCjsDefault(\n          filepath,\n          // @ts-ignore(Babel 7 vs Babel 8) Removed in Babel 8\n          /* fallbackToTranspiledModule */ arguments[2],\n        );\n      }\n    case \".mjs\":\n      break;\n    case \".cts\":\n      return loadCtsDefault(filepath);\n    default:\n      try {\n        if (process.env.BABEL_8_BREAKING) {\n          return loadCjsDefault(filepath);\n        } else {\n          return loadCjsDefault(\n            filepath,\n            // @ts-ignore(Babel 7 vs Babel 8) Removed in Babel 8\n            /* fallbackToTranspiledModule */ arguments[2],\n          );\n        }\n      } catch (e) {\n        if (e.code !== \"ERR_REQUIRE_ESM\") throw e;\n      }\n  }\n  if (yield* isAsync()) {\n    // eslint-disable-next-line @typescript-eslint/no-use-before-define\n    return yield* waitFor(loadMjsDefault(filepath));\n  }\n  throw new ConfigError(asyncError, filepath);\n}\n\nfunction loadCtsDefault(filepath: string) {\n  const ext = \".cts\";\n  const hasTsSupport = !!(\n    require.extensions[\".ts\"] ||\n    require.extensions[\".cts\"] ||\n    require.extensions[\".mts\"]\n  );\n\n  let handler: NodeJS.RequireExtensions[\"\"];\n\n  if (!hasTsSupport) {\n    const opts: InputOptions = {\n      babelrc: false,\n      configFile: false,\n      sourceType: \"unambiguous\",\n      sourceMaps: \"inline\",\n      sourceFileName: path.basename(filepath),\n      presets: [\n        [\n          getTSPreset(filepath),\n          {\n            onlyRemoveTypeImports: true,\n            optimizeConstEnums: true,\n            ...(process.env.BABEL_8_BREAKING\n              ? {}\n              : { allowDeclareFields: true }),\n          },\n        ],\n      ],\n    };\n\n    handler = function (m, filename) {\n      // If we want to support `.ts`, `.d.ts` must be handled specially.\n      if (handler && filename.endsWith(ext)) {\n        try {\n          // @ts-expect-error Undocumented API\n          return m._compile(\n            transformFileSync(filename, {\n              ...opts,\n              filename,\n            }).code,\n            filename,\n          );\n        } catch (error) {\n          if (!hasTsSupport) {\n            const packageJson = require(\"@babel/preset-typescript/package.json\");\n            if (semver.lt(packageJson.version, \"7.21.4\")) {\n              console.error(\n                \"`.cts` configuration file failed to load, please try to update `@babel/preset-typescript`.\",\n              );\n            }\n          }\n          throw error;\n        }\n      }\n      return require.extensions[\".js\"](m, filename);\n    };\n    require.extensions[ext] = handler;\n  }\n  try {\n    return loadCjsDefault(filepath);\n  } finally {\n    if (!hasTsSupport) {\n      if (require.extensions[ext] === handler) delete require.extensions[ext];\n      handler = undefined;\n    }\n  }\n}\n\nconst LOADING_CJS_FILES = new Set();\n\nfunction loadCjsDefault(filepath: string) {\n  // The `require()` call below can make this code reentrant if a require hook\n  // like @babel/register has been loaded into the system. That would cause\n  // Babel to attempt to compile the `.babelrc.js` file as it loads below. To\n  // cover this case, we auto-ignore re-entrant config processing. ESM loaders\n  // do not have this problem, because loaders do not apply to themselves.\n  if (LOADING_CJS_FILES.has(filepath)) {\n    debug(\"Auto-ignoring usage of config %o.\", filepath);\n    return {};\n  }\n\n  let module;\n  try {\n    LOADING_CJS_FILES.add(filepath);\n    module = endHiddenCallStack(require)(filepath);\n  } finally {\n    LOADING_CJS_FILES.delete(filepath);\n  }\n\n  if (process.env.BABEL_8_BREAKING) {\n    return module?.__esModule ? module.default : module;\n  } else {\n    return module?.__esModule\n      ? module.default ||\n          /* fallbackToTranspiledModule */ (arguments[1] ? module : undefined)\n      : module;\n  }\n}\n\nconst loadMjsDefault = endHiddenCallStack(async function loadMjsDefault(\n  filepath: string,\n) {\n  const url = pathToFileURL(filepath).toString();\n\n  if (process.env.BABEL_8_BREAKING) {\n    return (await import(url)).default;\n  } else {\n    if (!import_) {\n      throw new ConfigError(\n        \"Internal error: Native ECMAScript modules aren't supported by this platform.\\n\",\n        filepath,\n      );\n    }\n\n    return (await import_(url)).default;\n  }\n});\n\nfunction getTSPreset(filepath: string) {\n  try {\n    // eslint-disable-next-line import/no-extraneous-dependencies\n    return require(\"@babel/preset-typescript\");\n  } catch (error) {\n    if (error.code !== \"MODULE_NOT_FOUND\") throw error;\n\n    let message =\n      \"You appear to be using a .cts file as Babel configuration, but the `@babel/preset-typescript` package was not found: please install it!\";\n\n    if (!process.env.BABEL_8_BREAKING) {\n      if (process.versions.pnp) {\n        // Using Yarn PnP, which doesn't allow requiring packages that are not\n        // explicitly specified as dependencies.\n        message += `\nIf you are using Yarn Plug'n'Play, you may also need to add the following configuration to your .yarnrc.yml file:\n\npackageExtensions:\n\\t\"@babel/core@*\":\n\\t\\tpeerDependencies:\n\\t\\t\\t\"@babel/preset-typescript\": \"*\"\n`;\n      }\n    }\n\n    throw new ConfigError(message, filepath);\n  }\n}\n"],"mappings":"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","ignoreList":[]}