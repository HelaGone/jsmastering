{"version":3,"file":"utils.js","names":["_caching","require","fs","_fs2","data","makeStaticFileCache","fn","makeStrongCache","_regeneratorRuntime","mark","_callee","filepath","cache","cached","wrap","_callee$","_context","prev","next","invalidate","fileMtime","abrupt","t0","t1","delegateYield","readFile","t3","t2","stop","existsSync","statSync","mtime","e","code"],"sources":["../../../src/config/files/utils.ts"],"sourcesContent":["import type { Handler } from \"gensync\";\n\nimport { makeStrongCache } from \"../caching.ts\";\nimport type { CacheConfigurator } from \"../caching.ts\";\nimport * as fs from \"../../gensync-utils/fs.ts\";\nimport nodeFs from \"fs\";\n\nexport function makeStaticFileCache<T>(\n  fn: (filepath: string, contents: string) => T,\n) {\n  return makeStrongCache(function* (\n    filepath: string,\n    cache: CacheConfigurator<void>,\n  ): Handler<null | T> {\n    const cached = cache.invalidate(() => fileMtime(filepath));\n\n    if (cached === null) {\n      return null;\n    }\n\n    return fn(filepath, yield* fs.readFile(filepath, \"utf8\"));\n  });\n}\n\nfunction fileMtime(filepath: string): number | null {\n  if (!nodeFs.existsSync(filepath)) return null;\n\n  try {\n    return +nodeFs.statSync(filepath).mtime;\n  } catch (e) {\n    if (e.code !== \"ENOENT\" && e.code !== \"ENOTDIR\") throw e;\n  }\n\n  return null;\n}\n"],"mappings":";;;;;;;;AAEA,IAAAA,QAAA,GAAAC,OAAA;AAEA,IAAAC,EAAA,GAAAD,OAAA;AACA,SAAAE,KAAA;EAAA,IAAAC,IAAA,GAAAH,OAAA;EAAAE,IAAA,YAAAA,KAAA;IAAA,OAAAC,IAAA;EAAA;EAAA,OAAAA,IAAA;AAAA;AAEO,SAASC,mBAAmBA,CACjCC,EAA6C,EAC7C;EACA,OAAO,IAAAN,QAAA,CAAAO,eAAe,gBAAAC,mBAAA,GAAAC,IAAA,CAAC,SAAAC,QACrBC,QAAgB,EAChBC,KAA8B;IAAA,IAAAC,MAAA;IAAA,OAAAL,mBAAA,GAAAM,IAAA,UAAAC,SAAAC,QAAA;MAAA,kBAAAA,QAAA,CAAAC,IAAA,GAAAD,QAAA,CAAAE,IAAA;QAAA;UAExBL,MAAM,GAAGD,KAAK,CAACO,UAAU,CAAC;YAAA,OAAMC,SAAS,CAACT,QAAQ,CAAC;UAAA,EAAC;UAAA,MAEtDE,MAAM,KAAK,IAAI;YAAAG,QAAA,CAAAE,IAAA;YAAA;UAAA;UAAA,OAAAF,QAAA,CAAAK,MAAA,WACV,IAAI;QAAA;UAAAL,QAAA,CAAAM,EAAA,GAGNhB,EAAE;UAAAU,QAAA,CAAAO,EAAA,GAACZ,QAAQ;UAAE,OAAAK,QAAA,CAAAQ,aAAA,CAAOtB,EAAE,CAACuB,QAAQ,CAACd,QAAQ,EAAE,MAAM,CAAC;QAAA;UAAAK,QAAA,CAAAU,EAAA,GAAAV,QAAA,CAAAW,EAAA;UAAA,OAAAX,QAAA,CAAAK,MAAA,eAAAL,QAAA,CAAAM,EAAA,EAAAN,QAAA,CAAAO,EAAA,EAAAP,QAAA,CAAAU,EAAA;QAAA;QAAA;UAAA,OAAAV,QAAA,CAAAY,IAAA;MAAA;IAAA,GAAAlB,OAAA;EAAA,CACzD,EAAC;AACJ;AAEA,SAASU,SAASA,CAACT,QAAgB,EAAiB;EAClD,IAAI,CAACR,IAAA,CAAK,CAAC,CAAC0B,UAAU,CAAClB,QAAQ,CAAC,EAAE,OAAO,IAAI;EAE7C,IAAI;IACF,OAAO,CAACR,IAAA,CAAK,CAAC,CAAC2B,QAAQ,CAACnB,QAAQ,CAAC,CAACoB,KAAK;EACzC,CAAC,CAAC,OAAOC,CAAC,EAAE;IACV,IAAIA,CAAC,CAACC,IAAI,KAAK,QAAQ,IAAID,CAAC,CAACC,IAAI,KAAK,SAAS,EAAE,MAAMD,CAAC;EAC1D;EAEA,OAAO,IAAI;AACb;AAAC","ignoreList":[]}